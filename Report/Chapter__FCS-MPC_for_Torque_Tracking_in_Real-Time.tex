
\chapter{High-Speed FCS-MPC for Torque Tracking}



\section{Cost reformulation for SDP}

\subsection{Matrices for full horizon dynamics}

Next, we will obtain a direct representation of the cost with matrices. Therefore, we introduce the full-horizon variables in Table \ref{tab:0}.
\begin{table}[h!]
	\centering
	\begin{tabular}{ll}
		\toprule
		variable name & variable description \\
		\midrule[\heavyrulewidth]
		$\b{\psi}_s(k) = [\psi_s^\top(k+1),\ \psi_s^\top(k+2),\ldots,\ \psi_s^\top(k+N)]^\top$ & Stator Flux \\
		$\b{\psi}_r(k) = [\psi_r^\top(k+1),\ \psi_r^\top(k+2),\ldots,\ \psi_r^\top(k+N)]^\top$ & Rotor Flux \\
		$\b{T}(k) = [T(k+1),\ T(k+2),\ldots,\ T(k+N)]^\top$ & Torque \\
		$\b{\Psi}_s(k) = [\Psi_s(k+1),\ \Psi_s(k+2),\ldots,\ \Psi_s(k+N)]^\top$ & Absolute stator flux \\
		$\b{T}^*(k) = [T^*(k+1),\ T^*(k+2),\ldots,\ T^*(k+N)]^\top$ & Torque reference \\
		$\b{\Psi}^*_s(k) = [\Psi_s^*(k+1),\ \Psi^*_s(k+2),\ldots,\ \Psi_s^*(k+N)]^\top$ & Absolute stator flux reference \\
		$\b{U}(k) = [\b{u}^\top(k),\ \b{u}^\top(k+1),\ldots,\ \b{u}^\top(k+N-1)]^\top$ & Inputs \\
		\bottomrule
	\end{tabular}
	\caption{Full horizon variables}
	\label{tab:0}
\end{table}\\
While the references $\b{T}^*(k),\ \b{\Psi}^*(k)$ are given, we will have to find a formulation to compute the actual values of $\b{\Psi}_s(k)$ and $\b{T}(k)$.\\
Utilizing \eqref{eq:0} and \eqref{eq:1} we get the matrix representations
\begin{equation*}
	\psi_s(k+l) = \underbrace{\left[\b{A}_1\ \b{B}_1\right]\b{A}^{l-1}}_{\b{\Gamma}_\s}\b{x}(k) + \underbrace{\left[\begin{array}{ccccc}
			\left[\b{A}_1\ \b{B}_1\right]\b{A}^{l-2}\b{B} & \left[\b{A}_1\ \b{B}_1\right]\b{A}^{l-3}\b{B} & \ldots & \left[\b{A}_1\ \b{B}_1\right]\b{B} & \b{B}_2
		\end{array} \right]}_{\b{\Upsilon}_\s}\b{U}(k)
\end{equation*}
and
\begin{equation*}
	\psi_r(k+l) = \underbrace{\left[\b{B}_3\ \b{A}_2\right]\b{A}^{l-1}}_{\b{\Gamma}_r}\b{x}(k) + \underbrace{\left[\begin{array}{ccccc}
			\left[\b{B}_3\ \b{A}_2\right]\b{A}^{l-2}\b{B} & \left[\b{B}_3\ \b{A}_2\right]\b{A}^{l-3}\b{B} & \ldots & \left[\b{B}_3\ \b{A}_2\right]\b{B} & \b{0}
		\end{array} \right]}_{\b{\Upsilon}_r}\b{U}(k).
\end{equation*}

%\clearpage
%
%This can further be used to obtain the full horizon of the stator flux
%\begin{align*}
%	\b{\psi}_s(k) &=  \left[	\b{A}_1 \b{B}_1\right] \left[\begin{array}{c}
%		\I \\
%		\b{A} \\
%		\b{A}^2 \\
%		\vdots \\
%		\b{A}^{N-1}
%	\end{array}\right] \b{x}(k) + 
%\left[\begin{array}{ccccc}
%	\b{B}_2 & & & & \b{0} \\
%	\left[\b{A}_1\ \b{B}_1\right]\b{B} & \b{B}_2 & & & \\
%	\left[\b{A}_1\ \b{B}_1\right]\b{AB} & \left[\b{A}_1\ \b{B}_1\right]\b{B} & \b{B}_2 && \\
%	\vdots & \vdots & \vdots & \ddots & \\
%	\left[\b{A}_1\ \b{B}_1\right]\b{A}^{N-2}\b{B} & \left[\b{A}_1\ \b{B}_1\right]\b{A}^{N-3}\b{B} & \left[\b{A}_1\ \b{B}_1\right]\b{A}^{N-4}\b{B} & \cdots & \b{B}_2 \\
%\end{array}\right]\b{U}(k) \\
%	&=: \b{\Gamma}_s\b{x}(k) + \b{\Upsilon}_s\b{U}(k)
%\end{align*}
%and the rotor flux
%\begin{align*}
%	\b{\psi}_r(k) &=  \left[\b{B}_3 \b{A}_2\right] \left[\begin{array}{c}
%		\I \\
%		\b{A} \\
%		\b{A}^2 \\
%		\vdots \\
%		\b{A}^{N-1}
%	\end{array}\right] \b{x}(k) + 
%	\left[\begin{array}{ccccc}
%		\b{0} & & & & \b{0} \\
%		\left[\b{B}_3 \b{A}_2\right] \b{B} & \b{0} & & & \\
%		\left[\b{B}_3 \b{A}_2\right] \b{AB} & \left[\b{B}_3 \b{A}_2\right] \b{B} & \b{0} && \\
%		\vdots & \vdots & \vdots & \ddots & \\
%		\left[\b{B}_3 \b{A}_2\right] \b{A}^{N-2}\b{B} & \left[\b{B}_3 \b{A}_2\right] \b{A}^{N-3}\b{B} & \left[\b{B}_3 \b{A}_2\right] \b{A}^{N-4}\b{B} & \cdots & \b{0} \\
%	\end{array}\right]\b{U}(k)\\
%	&=: \b{\Gamma}_r\b{x}(k) + \b{\Upsilon}_r\b{U}(k).
%\end{align*}



\subsection{Matrix representations of torque, stator flux, and switching penalty}
Stator flux:
\begin{align}\label{eq:3}
	\Psi_s^2(k+l) &= ||\b{\psi}_s(k+l)||_2^2 
	= \b{\psi}_s^\top(k+l)\b{\psi}_s(k+l)
	= \left(\b{\Gamma}_\s\b{x}(k) + \b{\Upsilon}_\s\b{U}(k)\right)^\top\left(\b{\Gamma}_\s\b{x}(k) + \b{\Upsilon}_\s\b{U}(k)\right) \\
	&= \b{x}^\top(k)\b{\Gamma}_\s^\top \b{\Gamma}_\s \b{x}(k)
	+ \b{x}^\top(k)\b{\Gamma}_\s^\top\b{\Upsilon}_\s\b{U}(k)
	+ \b{U}^\top(k)\b{\Upsilon}_\s^\top\b{\Gamma}_\s\b{x}(k)
	+ \b{U}^\top(k)\b{\Upsilon}_\s^\top\b{\Upsilon}_\s\b{U}(k)\\
	&= [\begin{array}{cc}
		1 & \b{U}^\top(k)
	\end{array}] \underbrace{ \left[\begin{array}{cc}
		\b{x}^\top(k) \b{\Gamma}_\s^\top\b{\Gamma}_\s \b{x}(k) & \b{x}^\top(k)\b{\Gamma}_\s^\top\b{\Upsilon}_\s \\
		\b{\Upsilon}_\s^\top\b{\Gamma}_\s\b{x}(k) & \b{\Upsilon}_\s^\top\b{\Upsilon}_\s
	\end{array}\right] }_{\b{W}} \left[\begin{array}{c}
		1 \\
		\b{U}(k)
	\end{array}\right]
\end{align}
%Full horizon stator flux:
%\begin{align*}
%	\b{\Psi}_s^2(k) = \left[\begin{array}{c}
%		\Psi_s^2(k)\\
%		\Psi_s^2(k+1)
%	\end{array}\right],
%\end{align*}
%where the squared-operation is an element-wise operation.
Torque:
\begin{align}
	T(k+l) &= \Tfac\b{\psi}_r^\top(k+l)\b{\Xi}\b{\psi}_s(k+l)
	= \Tfac\left(\b{\Gamma}_r\b{x}(k) + \b{\Upsilon}_r\b{U}(k)\right)^\top \b{\Xi} \left(\b{\Gamma}_\s\b{x}(k) + \b{\Upsilon}_\s\b{U}(k)\right) \\
	&= \Tfac\left(\b{x}^\top(k)\b{\Gamma}_r^\top \b{\Xi} \b{\Gamma}_r \b{x}(k)
	+ \b{x}^\top(k)\b{\Gamma}_r^\top \b{\Xi} \b{\Upsilon}_\s\b{U}(k)
	+ \b{U}^\top(k)\b{\Upsilon}_r^\top \b{\Xi} \b{\Gamma}_\s\b{x}(k)
	+ \b{U}^\top(k)\b{\Upsilon}_r^\top \b{\Xi} \b{\Upsilon}_\s\b{U}(k)\right) \\
	&= \Tfac[\begin{array}{cc}
		1 & \b{U}^\top(k)
	\end{array}] \underbrace{ \left[\begin{array}{cc}
		\b{x}^\top(k) \b{\Gamma}_r^\top \b{\Xi}\b{\Gamma}_\s \b{x}(k) & \b{x}^\top(k)\b{\Gamma}_r^\top \b{\Xi} \b{\Upsilon}_\s \\
		\b{\Upsilon}_r^\top \b{\Xi} \b{\Gamma}_\s\b{x}(k) & \b{\Upsilon}_r^\top \b{\Xi} \b{\Upsilon}_\s
	\end{array}\right] }_{\b{Q}} \left[\begin{array}{c}
		1 \\
		\b{U}(k)
	\end{array}\right]
\end{align}
%\begin{align*}
%	\b{T}(k) &= \left[\begin{array}{c}
%		T(k+1) \\
%		T(k+2) \\
%		\vdots \\
%		T(k+N+1)
%	\end{array}\right]
%	= \Tfac\left[\begin{array}{c}
%		\b{\psi}_r(k+1)\Xi\b{\psi}_s(k+1) \\
%		\b{\psi}_r(k+2)\Xi\b{\psi}_s(k+2) \\
%		\vdots \\
%		\b{\psi}_r(k+N+1)\Xi\b{\psi}_s(k+N+1)
%	\end{array}\right] \\
%	&= \Tfac\b{\psi}_r(k) \left[\begin{array}{ccc}
%		\Xi & & \\
%		& \ddots & \\
%		& & \Xi
%	\end{array}\right]\b{\psi}_s(k) := \Tfac\b{\psi}_r(k) \Xi \b{\psi}_s(k)
%\end{align*}
The switching penalty is a term that depends on each phase at each time step. Thus, the switching transition $\Delta\b{u}(k)$ cannot be calculated in closed form, but has to be split up into each phase. The term $\Delta \b{u}(k)$ additionally depends on the previous input, which necessitates the usage of the constant term. Next, the polynomial decomposition for two ($\A$, $\B$) of three phases at time step $k$ are are shown.
\begin{align}
	\Delta u_\A(k) &= u_\A(k) - u_\A(k-1) \\
	&= [\begin{array}{cccccc}
		1 & \b{u}_\A(k) & \b{u}_\B(k) & \b{u}_\C(k) & \ldots & \b{u}_\C(k+N-1)
	\end{array}]
	\underbrace{ \left[\begin{array}{ccc}
		-\b{u}_\A(k-1) & 1 & \0 \\
		& \0 & 
	\end{array}\right] }_{\b{Z}_{a,0}}
	\left[\begin{array}{c}
		1 \\
		\b{u}_\A(k)\\
		\b{u}_\B(k)\\
		\b{u}_\C(k)\\
		\vdots\\
		\b{u}_\C(k+N-1)
	\end{array}\right]
\end{align}
\begin{align}
	\Delta u_\B(k) &= u_\B(k) - u_\B(k-1) \\
	&= [\begin{array}{cccccc}
		1 & \b{u}_\A(k) & \b{u}_\B(k) & \b{u}_\C(k) & \ldots & \b{u}_\C(k+N-1)
	\end{array}]
	\left[\begin{array}{cccc}
		-\b{u}_\B(k-1) & 0 & 1 & \0 \\
		& \0 &  & 
	\end{array}\right]
	\left[\begin{array}{c}
		1 \\
		\b{u}_\A(k)\\
		\b{u}_\B(k)\\
		\b{u}_\C(k)\\
		\vdots\\
		\b{u}_\C(k+N-1)
	\end{array}\right]
\end{align}
The computation of all other switching transitions depend on the Inputs $\b{U}(k)$ so that the polynomial presentation can be generalized to 
\begin{align}
	\Delta u_\A(k) &= u_\A(k) - u_\A(k-1) \\
	&= [\begin{array}{cccccc}
		1 & \b{u}_\A(k) & \b{u}_\B(k) & \b{u}_\C(k) & \ldots & \b{u}_\C(k+N-1)
	\end{array}]
	\left[\begin{array}{cccc}
		0 & \0_{1\times3l} & -1 & \0 \\
		& \0 & &
	\end{array}\right]
	\left[\begin{array}{c}
		1 \\
		\b{u}_\A(k)\\
		\b{u}_\B(k)\\
		\b{u}_\C(k)\\
		\vdots\\
		\b{u}_\C(k+N-1)
	\end{array}\right]
\end{align}
for the a-phase and
\begin{align}\label{eq:4}
	\Delta u_\B(k) &= u_\B(k+l) - u_\B(k+l-1) \\
	&= [\begin{array}{cccccc}
		1 & \b{u}_\A(k) & \b{u}_\B(k) & \b{u}_\C(k) & \ldots & \b{u}_\C(k+N-1)
	\end{array}]
	\left[\begin{array}{cccc}
		0 & \0_{1\times(3l+1)} & 1 & \0 \\
		& \0 &  & 
	\end{array}\right]
	\left[\begin{array}{c}
		1 \\
		\b{u}_\A(k)\\
		\b{u}_\B(k)\\
		\b{u}_\C(k)\\
		\vdots\\
		\b{u}_\C(k+N-1)
	\end{array}\right]
\end{align}
for the b-phase, where $l \in \{1,\ 2, \ldots,\ N-1\}$.

\subsection{Final cost formulation}
The full horizon cost stated in \eqref{eq:2} is non-convex because of the torque- and absolute stator flux tracking terms. Using the definitions \eqref{eq:3} to \eqref{eq:4}, we get
\begin{align}
	J_N(k) &= \lambda_T \sum_{l = k}^{k+N-1} \left|\left|T^*(l+1)-\Tfac [1\ \b{U}^\top(k)]\b{Q}\left[\begin{array}{c}
		1\\
		\b{U}(k)
	\end{array}\right]\right|\right|_2^2 \\
	&\ + (1-\lambda_T) \sum_{l = k}^{k+N-1} \left|\left|(\Psi_s^*(l+1))^2-[1\ \b{U}^\top(k)]\b{W}\left[\begin{array}{c}
		1\\
		\b{U}(k)
	\end{array}\right]\right|\right|_2^2 \nonumber \\
	&\ + \lambda_u \sum_{l \in \{k,\ldots,k+N-1\}, z \in \{\A,\B,\C\}}^{k+N-1} \left|[1\ \b{U}^\top(k)]\b{Z}_{z,l}\left[\begin{array}{c}
		1\\
		\b{U}(k)
	\end{array}\right]\right|. \nonumber
\end{align}
Using the identity
\begin{equation*}
	\b{v}^\top \b{Q} \b{v} = \mathrm{trace} \left( \b{Qvv}^\top \right),
\end{equation*}
we get
\begin{align*}
	J_N(k) &= \lambda_T \sum_{l = k}^{k+N-1} \left|\left|T^*(l+1)-\Tfac \mathrm{trace} \left(\b{QX}\right) \right|\right|_2^2 \\
	&\ + (1-\lambda_T) \sum_{l = k}^{k+N-1} \left|\left|(\Psi_s^*(l+1))^2-\mathrm{trace} \left(\b{WX}\right)\right|\right|_2^2 \nonumber \\
	&\ + \lambda_u \sum_{l \in \{k,\ldots,k+N-1\}, z \in \{\A,\B,\C\}}^{k+N-1} \left| \mathrm{trace} \left( \b{Z}_{z,l}\b{X} \right) \right|, \nonumber
\end{align*}
where
\begin{equation}
	\b{X} = \left[\begin{array}{c}
		1\\
		\b{U}(k)
	\end{array}\right] [1\ \b{U}^\top(k)].
\end{equation}
This cost formulation can later be used for the SDP relaxation.
\begin{align*}
	\b{U}_\augp^\opt(k) = \ &\argmin_{\b{U}_\augp(k)} J_N(k) \\
	&\begin{array}{llr}
		\mathrm{s.t.} & \b{x}_\augp(l+1) = \b{A}_\augp\b{x}_\augp(l) + \b{B}_\augp\b{u}_\augp(l) + \b{D}_\augp\b{v}_g(l), & \forall l\in\{k, \ldots,\ k + N_\p-1\}\sp \\
		& \b{y}_\augp(l+1) = \b{C}_\augp \b{x}_\augp(l+1), & \forall l\in\{k, \ldots,\ k + N_\p - 1\}\sp \\
		& \b{u}_\ph(l) \in \{-1,\ 0,\ 1\}^{3}, &\forall l\in\{k, \ldots,\ k+N_\p - 1\}\sp \\
		& \b{p}(l) = | \Delta \b{u}_\ph(l) |, & \forall l\in\{k, \ldots,\ k + N_\p-1\}.
	\end{array} \nonumber
\end{align*}

\subsection{SDP formulation}
We will now use the new cost term to formulate the optimization problem




\section{Algorithms}



